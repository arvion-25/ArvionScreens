<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Display Player</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>html,body,video{height:100%;margin:0;background:#000}video{width:100%;height:100%;object-fit:contain}</style>
</head>
<body>
  <video id="adPlayer" autoplay muted controls></video>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-client.js"></script>

  <script>
    const BUCKET = 'ads-videos';
    const player = document.getElementById('adPlayer');
    const userId = sessionStorage.getItem('logged_user_id');
    const loginRowId = sessionStorage.getItem('login_row_id');

    if (!userId) {
      // GitHub Pages safe redirect: always point to index.html (relative)
      window.location = './index.html';
      throw new Error('Not logged in');
    }

    async function fetchPlaylist() {
      // fetch videos assigned to this display user (videos.display_user_id)
      const { data, error } = await supabase.from('videos').select('storage_path').eq('display_user_id', userId).order('uploaded_at', { ascending: true });
      if (error) { console.error(error); return []; }
      // get public URLs
      const urls = [];
      for (const row of (data||[])) {
        const { publicURL, error: e } = supabase.storage.from(BUCKET).getPublicUrl(row.storage_path);
        // supabase v2 returns object: { data: { publicUrl } } in some older libs; handle both:
        if (publicURL) urls.push(publicURL);
        else if (publicURL === undefined && publicURL !== null && publicURL !== '') {}
        else if (row.storage_path) {
          // try the new interface
          const pu = supabase.storage.from(BUCKET).getPublicUrl(row.storage_path);
          if (pu && pu.data && pu.data.publicUrl) urls.push(pu.data.publicUrl);
        }
      }
      return urls;
    }

    let playlist = [], idx = 0;
    async function start() {
      playlist = await fetchPlaylist();
      if (!playlist.length) {
        alert('No videos assigned to this display user yet.');
        return;
      }
      idx = 0;
      player.src = playlist[idx];
      player.play().catch(()=>{});
    }

    player.addEventListener('ended', () => {
      if (!playlist.length) return;
      idx = (idx + 1) % playlist.length;
      player.src = playlist[idx];
      player.play().catch(()=>{});
    });

    // heartbeat update last_ping if you use it
    setInterval(() => {
      const id = sessionStorage.getItem('login_row_id');
      if (id) {
        supabase.from('login_history').update({ last_ping: new Date().toISOString() }).eq('id', id).catch(()=>{});
      }
    }, 30000);

    // on close, update logout_time via best-effort (RPC or simple update)
    window.addEventListener('beforeunload', () => {
      const id = sessionStorage.getItem('login_row_id');
      if (id) {
        try {
          navigator.sendBeacon('/api/auto-logout', JSON.stringify({ loginId: id }));
        } catch(e) {
          // fallback: attempt supabase call (may not complete)
          supabase.from('login_history').update({ logout_time: new Date().toISOString() }).eq('id', id).catch(()=>{});
        }
      }
    });

    start();
  </script>
</body>
</html>
