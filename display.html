<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Display Player</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>html,body,video{height:100%;margin:0;background:#000}video{width:100%;height:100%;object-fit:contain}</style>
</head>
<body>
  <video id="adPlayer" autoplay muted controls></video>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-client.js"></script>

  <script>
    const BUCKET = 'ads-videos';
    const player = document.getElementById('adPlayer');

    // logged_user_id must be set by your login page (after successful login)
    const userId = sessionStorage.getItem('logged_user_id');
    const loginRowId = sessionStorage.getItem('login_row_id'); // if you store login_history id

    if (!userId) {
      window.location = '/';
      throw new Error('Not logged in');
    }

    async function loadPlaylist() {
      // fetch videos assigned to this display user
      const { data, error } = await supabase.from('videos').select('*').eq('display_user_id', userId).order('uploaded_at',{ascending:true});
      if (error) { console.error(error); return []; }
      const playlist = [];
      for (const v of (data || [])) {
        const { data: pu } = supabase.storage.from(BUCKET).getPublicUrl(v.storage_path);
        if (pu && pu.publicUrl) playlist.push({ url: pu.publicUrl, meta: v });
      }
      return playlist;
    }

    let playlist = [], idx = 0;

    async function startPlayer() {
      playlist = await loadPlaylist();
      if (!playlist.length) {
        alert('No videos assigned to this display user yet.');
        return;
      }
      idx = 0;
      player.src = playlist[idx].url;
      player.play().catch(()=>{});
    }

    player.addEventListener('ended', () => {
      if (!playlist.length) return;
      idx = (idx + 1) % playlist.length;
      player.src = playlist[idx].url;
      player.play().catch(()=>{});
    });

    // heartbeat: update login_history.last_ping if you implemented last_ping
    setInterval(() => {
      if (loginRowId) {
        supabase.from('login_history').update({ last_ping: new Date().toISOString() }).eq('id', loginRowId).catch(()=>{});
      }
    }, 30000);

    window.addEventListener('beforeunload', () => {
      // fire best-effort logout update
      if (loginRowId) {
        try { supabase.from('login_history').update({ logout_time: new Date().toISOString() }).eq('id', loginRowId).catch(()=>{}); } catch(e){}
      }
    });

    startPlayer();
  </script>
</body>
</html>
