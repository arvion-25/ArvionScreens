<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Display Player</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html,body{height:100%;margin:0;background:#000}
    video{width:100%;height:100%;object-fit:contain;background:#000}
    #fsBtn{position:fixed;top:12px;right:12px;z-index:50;padding:8px;background:#333;color:#fff;border:none;border-radius:6px}
  </style>
</head>
<body>
  <button id="fsBtn">Toggle Fullscreen</button>
  <video id="player" autoplay muted playsinline></video>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-client.js"></script>

  <script>
    const player = document.getElementById('player');
    const fsBtn = document.getElementById('fsBtn');

    async function loadAndPlay() {
      const { data, error } = await supabase.storage.from('ads-videos').list('', { limit: 500 });
      if (error || !data) {
        document.body.innerHTML = '<div style="color:#fff;padding:20px">No videos found.</div>';
        return;
      }
      const files = data.filter(f=>/\.(mp4|webm|ogg)$/i.test(f.name));
      if (!files.length) { document.body.innerHTML = '<div style="color:#fff;padding:20px">No playable videos.</div>'; return; }

      let idx = 0;
      async function setSrc(i) {
        const file = files[i].name;
        const { data: urlData } = supabase.storage.from('ads-videos').getPublicUrl(file);
        player.src = urlData.publicUrl;
        try { await player.play(); } catch(e) { console.warn(e); }
      }

      player.addEventListener('ended', ()=> {
        idx = (idx + 1) % files.length;
        setSrc(idx);
      });

      await setSrc(0);
    }

    // heartbeat updates last_ping
    async function sendHeartbeat() {
      const loginId = sessionStorage.getItem('login_id');
      if (!loginId) return;
      try {
        await supabase.from('login_history').update({ last_ping: new Date().toISOString() }).eq('id', loginId);
      } catch(e) { console.warn('heartbeat failed', e); }
    }

    // send logout using sendBeacon to Supabase REST RPC (apikey query param) + fallback fetch keepalive
    function sendLogoutKeepalive() {
      const loginId = sessionStorage.getItem('login_id');
      if (!loginId) return;
      const url = `${SUPABASE_URL}/rest/v1/rpc/record_logout?apikey=${encodeURIComponent(SUPABASE_ANON_KEY)}`;
      const payload = JSON.stringify({ lid: loginId });

      try {
        const blob = new Blob([payload], { type: 'application/json' });
        if (navigator.sendBeacon && navigator.sendBeacon(url, blob)) return;
      } catch(e){}

      try {
        fetch(url, {
          method:'POST',
          headers: {
            'Content-Type':'application/json',
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          },
          body: payload,
          keepalive: true
        }).catch(()=>{});
      } catch(e) { console.warn('logout fallback failed', e); }
    }

    window.addEventListener('beforeunload', sendLogoutKeepalive);
    setInterval(sendHeartbeat, 20000); // 20s heartbeat

    fsBtn.onclick = async () => {
      if (!document.fullscreenElement) await player.requestFullscreen().catch(()=>{});
      else document.exitFullscreen().catch(()=>{});
    };

    // run
    loadAndPlay();
    sendHeartbeat();
  </script>
</body>
</html>
